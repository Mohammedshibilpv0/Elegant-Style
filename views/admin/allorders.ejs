<%- include("../partials/user/adminheader.ejs")%>

<div
  id="main-wrapper"
  data-theme="light"
  data-layout="vertical"
  data-navbarbg="skin6"
  data-sidebartype="full"
  data-sidebar-position="fixed"
  data-header-position="fixed"
  data-boxed-layout="full"
>
  <!-- ============================================================== -->
  <!-- Topbar header - style you can find in pages.scss -->
  <!-- ============================================================== -->
  <header class="topbar" data-navbarbg="skin6">
    <nav class="navbar top-navbar navbar-expand-lg">
      <div class="navbar-header" data-logobg="skin6">
        <!-- This is for the sidebar toggle which is visible on mobile only -->
        <a
          class="nav-toggler waves-effect waves-light d-block d-lg-none"
          href="javascript:void(0)"
          ><i class="ti-menu ti-close"></i
        ></a>
        <!-- ============================================================== -->
        <!-- Logo -->
        <!-- ============================================================== -->
        <div class="navbar-brand">
          <!-- Logo icon -->
          <a href="home.ejs">
            <img
              src="/admin/assets/images/freedashDark.svg"
              alt=""
              class="img-fluid"
            />
          </a>
        </div>
        <!-- ============================================================== -->
        <!-- End Logo -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Toggle which is visible on mobile only -->
        <!-- ============================================================== -->
        <a
          class="topbartoggler d-block d-lg-none waves-effect waves-light"
          href="javascript:void(0)"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
          ><i class="ti-more"></i
        ></a>
      </div>
      <!-- ============================================================== -->
      <!-- End Logo -->
      <!-- ============================================================== -->
      <div class="navbar-collapse collapse" id="navbarSupportedContent">
        <ul class="navbar-nav float-end">
          <!-- ============================================================== -->
          <!-- Search -->
          <!-- ============================================================== -->
          <!-- <li class="nav-item d-none d-md-block">
                            <a class="nav-link" href="javascript:void(0)">
                                <form>
                                    <div class="customize-input">
                                        <input class="form-control custom-shadow custom-radius border-0 bg-white"
                                            type="search" placeholder="Search" aria-label="Search">
                                        <i class="form-control-icon" data-feather="search"></i>
                                    </div>
                                </form>
                            </a>
                        </li> -->

          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="javascript:void(0)"
              data-bs-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <span class="ms-2 d-none d-lg-inline-block"
                ><span>Hello,</span> <span class="text-dark"></span>
                <i data-feather="chevron-down" class="svg-icon"></i
              ></span>
            </a>
            <div
              class="dropdown-menu dropdown-menu-end dropdown-menu-right user-dd animated flipInY"
            >
              <a class="dropdown-item" href="javascript:void(0)"
                ><i data-feather="user" class="svg-icon me-2 ms-1"></i> My
                Profile</a
              >
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="/admin/logout"
                ><i data-feather="power" class="svg-icon me-2 ms-1"></i>
                Logout</a
              >
              <div class="dropdown-divider"></div>
            </div>
          </li>
          <!-- ============================================================== -->
          <!-- User profile and search -->
          <!-- ============================================================== -->
        </ul>
      </div>
    </nav>
  </header>
  <!-- ============================================================== -->
  <!-- End Topbar header -->
  <!-- ============================================================== -->
  <!-- ============================================================== -->
  <!-- Left Sidebar - style you can find in sidebar.scss  -->
  <!-- ============================================================== -->
  <aside class="left-sidebar" data-sidebarbg="skin6">
    <!-- Sidebar scroll-->
    <div class="scroll-sidebar" data-sidebarbg="skin6">
      <!-- Sidebar navigation-->
      <nav class="sidebar-nav">
        <ul id="sidebarnav">
          <li class="sidebar-item">
            <a
              class="sidebar-link sidebar-link"
              href="/admin/"
              aria-expanded="false"
              ><i data-feather="home" class="feather-icon"></i
              ><span class="hide-menu">Dashboard</span></a
            >
          </li>
          <li class="list-divider"></li>
          <li class="nav-small-cap"><span class="hide-menu">Users</span></li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/allusers" aria-expanded="false"
              ><i class="fa-regular fa-user"></i
              ><span class="hide-menu">All Users </span></a
            >
          </li>

          <li class="list-divider"></li>

          <li class="nav-small-cap"><span class="hide-menu">Products</span></li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/products" aria-expanded="false"
              ><i class="fa-regular fa-user"></i
              ><span class="hide-menu">All Product </span></a
            >
          </li>

          <li class="sidebar-item">
            <a
              class="sidebar-link"
              href="/admin/addproducts"
              aria-expanded="false"
              ><i class="fa-solid fa-plus"></i
              ><span class="hide-menu">Add Products</span></a
            >
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/category" aria-expanded="false"
              ><i class="fa-solid fa-list"></i
              ><span class="hide-menu">category</span></a
            >
          </li>

          <li class="list-divider"></li>
          <li class="nav-small-cap"><span class="hide-menu">Orders</span></li>

          <li class="sidebar-item">
            <a
              class="sidebar-link sidebar-link"
              href="/admin/allorders"
              aria-expanded="false"
              ><i class="fa-solid fa-cart-shopping"></i
              ><span class="hide-menu">All Orders </span></a
            >
          </li>
          <li class="sidebar-item"> <a class="sidebar-link sidebar-link" href="/admin/coupon"
            aria-expanded="false"><i class="fa-solid fa-cart-shopping"></i><span
                class="hide-menu">Coupon
            </span></a>
    </li>

          <li class="list-divider"></li>
          <li class="nav-small-cap"><span class="hide-menu">Extra</span></li>

          <li class="sidebar-item">
            <a
              class="sidebar-link sidebar-link"
              href="/admin/logout"
              aria-expanded="false"
              ><i data-feather="log-out" class="feather-icon"></i
              ><span class="hide-menu">Logout</span></a
            >
          </li>
        </ul>
      </nav>
      <!-- End Sidebar navigation -->
    </div>
    <!-- End Sidebar scroll-->
  </aside>
  <!-- ============================================================== -->
  <!-- End Left Sidebar - style you can find in sidebar.scss  -->
  <!-- ============================================================== -->
  <!-- ============================================================== -->
  <!-- Page wrapper  -->
  <!-- ============================================================== -->
  <div class="page-wrapper bg-dark" style="min-height: 775px">
    <div class="container mt-5">
      <div class="row">
        <div class="col-lg-12">
          <div class="main-box clearfix">
            <div class="table-responsive">
              <table class="table user-list" id="userTable" style="color: white;">
                <thead>
                    <tr>
                        <th><span class="ms-1">Order Id</span></th>
                        <th><span class="ms-1">User </span></th>
                        <th><span class="ms-1">Price</span></th>
                        <th><span class="ms-1">Address</span></th>
                        <th><span class="ms-1">Product </span></th>
                        <th><span class="ms-1">Quantity</span></th>
                        <th><span class="ms-1">Images</span></th>
                        <th><span >Status</span></th>
                        <th><span> Action</span></th>
                    </tr>
                </thead>
                <tbody>
                    <% allOrders.forEach(order => { %>
                        <% order.Products.forEach((product, index) => { %>
                            <tr class="mt-4">
                                <% if (index === 0) { %>
                                    <!-- Display order-related information only for the first product in the order -->
                                    <td rowspan="<%= order.Products.length %>">
                                        <p ><%= order._id %> </p>
                                    </td>
                                    <td rowspan="<%= order.Products.length %>">
                                        <p><%= order.user.Name %></p>
                                        <input type="text" value="<%= order.user._id %>" id="userid_<%= order._id %>" hidden>
                                    </td>
                                    <td rowspan="<%= order.Products.length %>">
                                        <p><%= order.total %></p>
                                    </td>
                                    <td rowspan="<%= order.Products.length %>">
                                        <p class="text-center"> <%= order.address %></p>
                                    </td>
                                <% } %>
                               
                                <td>
                                    <p><%= product.name %></p>
                                </td>
                                <td>
                                    <p class="text-center"><%= product.quantity %></p>
                                </td>
                                <td>
                                    <img class="circular-image" src="/uploads/<%= product.image %>" alt="<%= product.Name %> Image" onclick="openPopup('/uploads/<%= product.image %>')" />
                                    <div id="imagePopup" class="image-popup">
                                        <div class="popup-content">
                                            <span class="close-popup" onclick="closePopup()">&times;</span>
                                            <img id="popupImage" />
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <p id="orderStatus_<%= order._id %>"><%= product.Status %></p>
                                    <% if (product.Status == "returned") { %>
                                        <br>
                                        <!-- Button trigger modal -->
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal_<%= order._id %>">
                                            View
                                        </button>
            
                                        <!-- Modal -->
                                        <div class="modal fade" id="exampleModal_<%= order._id %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h1 class="modal-title fs-5" id="exampleModalLabel" style="color: black;">Reason of return</h1>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body" style="color: black;">
                                                        <p> Reason of return : &nbsp; <%= product.reason %></p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% } %>
                                </td>
                                <td>
                                  <td>
                                    <div class="btn-group">
                                      <div class="btn-group dropstart">
                                        <%if(product.Status=="request return"){%>
                                          <!-- Button trigger modal -->
                                          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal=<%= order._id %>">
                                            View
                                          </button>
    
                                          <!-- Modal -->
                                          <div class="modal fade" id="exampleModal=<%= order._id %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                              <div class="modal-content">
                                                <div class="modal-header">
                                                  <h1 class="modal-title fs-5 " id="exampleModalLabel" style="color: black;">Reason</h1>
                                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body" style="color: black;">
                                                  <p><%=product.reason%></p>
                                                </div>
                                                <div class="modal-footer">
                                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                  <a href="#" class="btn btn-danger"  onclick="updateStatus('returned', '<%= order._id %>','<%=product._id%>')">Request Approved</a>
    
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                          <%}else{%>
                                        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                          Status
                                        </button>
                                        <ul class="dropdown-menu" >
                                          <li ><a class="dropdown-item text-primary" href="#" onclick="updateStatus('shipped', '<%= order._id %>','<%=product._id%>')">Shipped</a></li>
                                          <li><a class="dropdown-item text-success" href="#" onclick="updateStatus('delivered', '<%= order._id %>','<%=product._id%>')">Delivered</a></li>
                                          <li><a class="dropdown-item text-danger" href="#" onclick="updateStatus('cancelled', '<%= order._id %>','<%=product._id%>')">Cancelled</a></li>
                                         
                                            
                                        
                                        </ul>
                                      </div>
                                    </div>
                                    <%}%>
                                  </td>
                            </tr>
                        <% }); %>
                    <% }); %>
                </tbody>
            </table>
            
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

 
  
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="/admin/css/allproducts.css">
<script>
      function openPopup(imageSrc) {
      // Set the source of the popup image
      document.getElementById("popupImage").src = imageSrc;

      // Show the popup
      document.getElementById("imagePopup").style.display = "flex";
    }

    function closePopup() {
      // Hide the popup
      document.getElementById("imagePopup").style.display = "none";
    }


//updating the status of product
function updateStatus(status, orderId, productid) {
    // Show SweetAlert confirmation dialog
    Swal.fire({
        title: 'Are you sure?',
        text: 'You are about to update the status. This action cannot be undone!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, update it!',
    }).then((result) => {
        if (result.isConfirmed) {
            // If user clicks "Yes" on the confirmation dialog

            // Make an AJAX request to update the status in the database
            const url = `/admin/updateStatus/${orderId}`; // Replace with your API endpoint
          const userid=document.getElementById(`userid_${orderId}`).value
            // Assuming you are using fetch API
            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status, productid,userid }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Handle the response from the server
                    console.log('Status updated successfully:', data);
                    // const orderStatusElement = document.getElementById(`orderStatus_${orderId}`);
                    // if (orderStatusElement) {
                    //     orderStatusElement.innerText = status;
                    // }
                    Swal.fire('Success!', 'Status updated successfully', 'success');
                    // Optionally, you can reload the page or update the UI here
                    window.location.reload();
                })
                .catch(error => {
                    // Handle errors
                    console.error('There was a problem updating the status:', error.message);
                    Swal.fire('Error', 'There was an error updating the status', 'error');
                });
        }
    });
}


</script>
<%-include("../partials/user/adminfooter.ejs")%>



